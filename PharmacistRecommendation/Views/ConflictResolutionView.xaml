<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="PharmacistRecommendation.Views.ConflictResolutionView"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:PharmacistRecommendation.ViewModels"
             x:DataType="viewmodels:ConflictResolutionViewModel"
             Title="Resolve Import Conflicts">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackLayout Grid.Row="0" Padding="20" BackgroundColor="LightYellow">
            <Label Text="Manual Medication Conflicts" FontSize="18" FontAttributes="Bold"/>
            <Label Text="The following manually-entered medications have conflicts with imported data. Please choose how to resolve each conflict:" FontSize="14"/>
        </StackLayout>

        <!-- Conflicts List -->
        <ScrollView Grid.Row="1" Padding="10">
            <StackLayout>
                <CollectionView ItemsSource="{Binding Conflicts}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="viewmodels:ConflictViewModel">
                            <Border Stroke="Gray" StrokeThickness="1" Margin="5" Padding="10" BackgroundColor="White">
                                <StackLayout>
                                    <!-- Medication Info -->
                                    <Label Text="{Binding MedicationDisplayName}" FontSize="16" FontAttributes="Bold" TextColor="DarkBlue"/>
                                    <Label Text="{Binding ConflictSummary}" FontSize="12" TextColor="Gray"/>

                                    <!-- Conflicting Fields -->
                                    <Label Text="Conflicting Fields:" FontSize="14" FontAttributes="Bold" Margin="0,10,0,5"/>
                                    <CollectionView ItemsSource="{Binding ConflictDetails}">
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate x:DataType="viewmodels:ConflictDetail">
                                                <Grid Padding="5,2">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="2*"/>
                                                        <ColumnDefinition Width="2*"/>
                                                    </Grid.ColumnDefinitions>

                                                    <Label Grid.Column="0" Text="{Binding FieldName}" FontAttributes="Bold"/>
                                                    <Label Grid.Column="1" Text="{Binding ExistingValue}" TextColor="Red" FontSize="12"/>
                                                    <Label Grid.Column="2" Text="{Binding ImportValue}" TextColor="Green" FontSize="12"/>
                                                </Grid>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>

                                    <!-- Resolution Options -->
                                    <Label Text="Resolution:" FontSize="14" FontAttributes="Bold" Margin="0,10,0,5"/>
                                    <RadioButton GroupName="{Binding ConflictId}" Content="Keep existing (manual) data" 
                                               IsChecked="{Binding KeepExisting}" />
                                    <RadioButton GroupName="{Binding ConflictId}" Content="Update to imported data" 
                                               IsChecked="{Binding UpdateToImport}" />
                                    <RadioButton GroupName="{Binding ConflictId}" Content="Skip this medication" 
                                               IsChecked="{Binding SkipMedication}" />
                                </StackLayout>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </StackLayout>
        </ScrollView>

        <!-- Action Buttons -->
        <Grid Grid.Row="2" Padding="20" BackgroundColor="LightGray">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Button Grid.Column="0" Text="Keep All Existing" Command="{Binding KeepAllExistingCommand}" 
                    BackgroundColor="Orange" TextColor="White" Margin="5"/>
            <Button Grid.Column="1" Text="Update All to Import" Command="{Binding UpdateAllToImportCommand}" 
                    BackgroundColor="Green" TextColor="White" Margin="5"/>
            <Button Grid.Column="2" Text="Apply Selections" Command="{Binding ApplySelectionsCommand}" 
                    BackgroundColor="Blue" TextColor="White" Margin="5"/>
        </Grid>

        <ActivityIndicator IsVisible="{Binding IsLoading}" IsRunning="{Binding IsLoading}" 
                         HorizontalOptions="Center" VerticalOptions="Center"/>
    </Grid>
</ContentPage>